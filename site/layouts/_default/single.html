{{ define "main" }}

<article>

<main class="article-layout">

  <aside class="article-sidebar">
    <h1 class="post-title">{{ .Title }}</h1>

    {{ with .Params.author }}
      <div class="post-author">
    {{ range . }}
      {{ $raw := . }}
      {{ $authorClean := replaceRE "[\\[\\]]" "" $raw   }}

      {{/* normalize: remove accented chars and punctuation, then urlize */}}
      {{ $norm := lower $authorClean }}
      {{ $norm = replaceRE "[áàâäãåā]" "a" $norm }}
      {{ $norm = replaceRE "[éèêëē]" "e" $norm }}
      {{ $norm = replaceRE "[íìîïī]" "i" $norm }}
      {{ $norm = replaceRE "[óòôöõō]" "o" $norm }}
      {{ $norm = replaceRE "[úùûüū]" "u" $norm }}
      {{ $norm = replaceRE "[ñ]" "n" $norm }}
      {{ $norm = replaceRE "[ç]" "c" $norm }}
      {{ $norm = replaceRE "[^a-z0-9\\s-]" "" $norm }}
      {{ $authorSlug := urlize $norm }}

      {{/* Find author page */}}
      {{ $authorPage := site.GetPage (printf "/autores/%s" $authorSlug) }}
      {{ if not $authorPage }}
        {{ $authorPage = where site.RegularPages "Params.slug" $authorSlug | first 1 }}
      {{ end }}
      {{ if not $authorPage }}
        {{ $authorPage = where site.RegularPages "RelPermalink" (print "/autores/" $authorSlug "/") | first 1 }}
      {{ end }}
      {{ if not $authorPage }}
        {{ $cand := where site.RegularPages "Section" "autores" }}
        {{ range $cand }}
          {{ $candidateName := lower (.Params.name | default .Title) }}
          {{ $candidateName = replaceRE "[áàâäãåā]" "a" $candidateName }}
          {{ $candidateName = replaceRE "[éèêëē]" "e" $candidateName }}
          {{ $candidateName = replaceRE "[íìîïī]" "i" $candidateName }}
          {{ $candidateName = replaceRE "[óòôöõō]" "o" $candidateName }}
          {{ $candidateName = replaceRE "[úùûüū]" "u" $candidateName }}
          {{ $candidateName = replaceRE "[ñ]" "n" $candidateName }}
          {{ $candidateName = replaceRE "[ç]" "c" $candidateName }}
          {{ $candidateName = replaceRE "[^a-z0-9\\s-]" "" $candidateName }}
          {{ if eq (urlize $candidateName) $authorSlug }}
            {{ $authorPage = . }}
            {{ break }}
          {{ end }}
        {{ end }}
      {{ end }}

      <div class="author-block">
        <h3 class="author-name" data-pagefind-filter="author">
          <a class="author-link" href="{{ (print "/autores/" $authorSlug) | relURL }}">
            {{ $authorClean }}
          </a>
        </h3>

        {{ with $authorPage.Params.bio }}
          <p class="author-bio">{{ . }}</p>
        {{ end }}

        {{ with $authorPage.Params.twitter_handle }}
          <div class="twitter-handle" data-pagefind-ignore>
            <a href="https://x.com/{{ . }}" target="_blank">@{{ . }}</a>
          </div>
        {{ end }}
      </div>

    {{ end }}
      </div>
    {{ end }}

    {{ with .Date }}
      {{ $months := dict
        "January" "enero"
        "February" "febrero"
        "March" "marzo"
        "April" "abril"
        "May" "mayo"
        "June" "junio"
        "July" "julio"
        "August" "agosto"
        "September" "septiembre"
        "October" "octubre"
        "November" "noviembre"
        "December" "diciembre"
      }}
      {{ $month := index $months (.Format "January") }}
      <p class="post-date">{{ .Day }} de {{ $month }} de {{ .Year }}</p>
    {{ end }}

    {{ partial "share.html" . }}

    {{ if and (isset .Params "thumbnail") (isset .Params "obra_reseñada") }}
      <div class="title-obra-resenada" data-pagefind-ignore>
        <h4>Obra reseñada</h4>
      </div>
      <div class="obra_reseñada" data-pagefind-ignore>
        {{ with index .Params.thumbnail 0 }}
          <div class="book-cover">
            <img src="{{ relURL .src }}" alt="Featured Image"/>
          </div>
        {{ end }}
        <div class="obra-text">{{ .Params.obra_reseñada | markdownify }}</div>
      </div>
    {{ end }}

    {{ with .Params.publicado_originalmente_en }}
      <div class="title-obra-resenada" data-pagefind-ignore>
        <h4>Publicado originalmente en</h4>
      </div>
      <div class="publicado-originalmente-en" data-pagefind-ignore>
        {{ . | markdownify }}
      </div>
    {{ end }}

    {{ with .Params.category }}
      <p class="post-category">{{ . }}</p>
    {{ end }}
  </aside> <!-- /.article-sidebar -->

  <div
    class="article-content"
    data-pagefind-body
    data-pagefind-filter-category="{{ with .Params.category }}{{ if (reflect.IsSlice .) }}{{ delimit . ", " }}{{ else }}{{ . }}{{ end }}{{ end }}"
    data-pagefind-filter-author="{{ with .Params.author }}{{ if (reflect.IsSlice .) }}{{ delimit . ", " }}{{ else }}{{ . }}{{ end }}{{ end }}"
  >

    {{/* Load raw thumbnail param */}}
      {{ $raw := .Params.thumbnail }}
      {{ $thumb := dict }}

      {{/* Case 1: it's a map */}}
      {{ if reflect.IsMap $raw }}
        {{ $thumb = $raw }}

      {{/* Case 2: it's a slice → take the first element */}}
      {{ else if reflect.IsSlice $raw }}
        {{ $thumb = index $raw 0 }}

      {{/* Case 3: it's a string */}}
      {{ else if (or (eq (printf "%T" $raw) "string") (eq (printf "%T" $raw) "*string")) }}
        {{ $thumb = dict "src" $raw }}
      {{ end }}

      {{/* If no src → render content normally */}}
      {{ if not $thumb.src }}
        {{ .Content | safeHTML }}
      {{ else }}

        {{/* Build HTML using Scratch */}}
        {{- $.Scratch.Delete "thumbHTML" -}}
        {{- $src := "" -}}

        {{/* Resolve resource vs static path */}}
        {{- with .Resources.GetMatch $thumb.src }}
          {{- $src = .RelPermalink -}}
        {{- else }}
          {{- $src = ($thumb.src | relURL) -}}
        {{- end }}

        {{- $.Scratch.Set "thumbHTML" (printf "<figure class='thumbnail-insert'>") -}}
        {{- $.Scratch.Add "thumbHTML" (printf "<img src='%s' alt=''>" $src) -}}

        {{- if or $thumb.epigraph $thumb.copyright }}
          {{- $.Scratch.Add "thumbHTML" "<figcaption>" -}}
            {{- if $thumb.epigraph }}
              {{- $.Scratch.Add "thumbHTML" (printf "<span class='epigraph'>%s</span>" $thumb.epigraph) -}}
            {{- end }}
            {{- if $thumb.copyright }}
              {{- $.Scratch.Add "thumbHTML" (printf "<span class='copyright'>%s</span>" $thumb.copyright) -}}
            {{- end }}
          {{- $.Scratch.Add "thumbHTML" "</figcaption>" -}}
        {{- end }}

        {{- $.Scratch.Add "thumbHTML" "</figure>" -}}
        {{ $thumbHTML := $.Scratch.Get "thumbHTML" }}

        {{/* Insert after third </p> */}}
        {{ $regex := `(?s)((?:.*?</p>){3})` }}
        {{ $replacement := printf "${1}%s" $thumbHTML }}
        {{ $content := .Content }}
        {{ $new := replaceRE $regex $replacement $content 1 }}

        {{ if ne $new $content }}
          {{ $new | safeHTML }}
        {{ else }}
          {{ printf "%s\n%s" $content $thumbHTML | safeHTML }}
        {{ end }}

      {{ end }}
  </div>

</main>

{{ partial "author.html" . }}
{{ partial "info.html" . }}
{{ partial "prev_next.html" . }}
{{ partial "comments.html" . }}

</article>

{{ end }}
