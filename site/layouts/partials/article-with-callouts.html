{{/* ---------------------------------------------------------
   Extract blocks, footnotes, and callouts
------------------------------------------------------------ */}}

{{ $raw := .RawContent }}
{{ $blocks := split $raw "\n\n" }}

{{ $callouts := .Params.callouts | default slice }}
{{ $countCallouts := len $callouts }}
{{ $positions := shuffle (seq (len $blocks)) | first $countCallouts }}

{{/* ---------------------------------------------------------
   Pre-extract all footnotes (Pandoc-style)
------------------------------------------------------------ */}}

{{/* Matches: [^1]: This is a note */}}
{{ $footnoteRE := `(?m)^\[\^([0-9]+)\]:(.*)` }}
{{ $allFootnotes := findRE $footnoteRE $raw }}
{{ $footMap := dict }}

{{ range $i, $m := $allFootnotes }}
  {{ $num := index $m 1 | trim " " }}
  {{ $txt := index $m 2 | trim " " }}
  {{ $footMap = merge $footMap (dict $num $txt) }}
{{ end }}

{{/* ---------------------------------------------------------
   Render each block
------------------------------------------------------------ */}}

<div class="article-wrapper">
  <div class="article-content">

    {{ range $i, $b := $blocks }}

      {{/* ---------------------------------------------------
         (1) Detect whether THIS block contains footnote refs
      ------------------------------------------------------ */}}
      {{ $footRefs := findRE `\[\^([0-9]+)\]` $b }}
      {{ $refsInBlock := slice }}

      {{ range $footRefs }}
        {{ $id := index . 1 | trim " " }}
        {{ $refsInBlock = $refsInBlock | append $id }}
      {{ end }}

      <div class="para-block-wrapper">

        <div class="para-block">
          {{ $b | markdownify }}
        </div>

        {{/* ---------------------------------------------------
           (2) Sidebar FOOTNOTES for this block only
        ------------------------------------------------------ */}}
        <aside class="sidebar-footnotes">

          {{ range $refsInBlock }}
            {{ $note := index $footMap . }}

            {{ if $note }}
            <div class="sidebar-footnote" id="fn:{{ . }}">
              <p>
                {{ $note | markdownify }}  
                <a href="#fnref:{{ . }}" class="footnote-backref">↩</a>
              </p>
            </div>
            {{ end }}

          {{ end }}

          {{/* ---------------------------------------------------
             (3) Sidebar CALLOUT if this position matches
          ------------------------------------------------------ */}}
          {{ $match := where $positions "==" $i }}
          {{ if gt (len $match) 0 }}
            {{ $calloutIndex := sub (len $positions) (len $match) }}
            {{ with index $callouts $calloutIndex }}
              <div class="callout-block">
                {{ . | markdownify }}
              </div>
            {{ end }}
          {{ end }}

        </aside>

      </div> <!-- para-block-wrapper -->

    {{ end }}

  </div>
</div>

{{/* ---------------------------------------------------------
   Do NOT render Hugo’s autogenerated endnotes
------------------------------------------------------------ */}}
<style>
  .footnotes, .footnotes * {
    display: none !important;
  }
</style>
